import React, { useState } from 'react';
import { useChildMode } from '../../context/ChildModeContext';

/**
 * ğŸ“– RubyCharacter - æ³¨éŸ³æ¨™æ³¨æ–‡å­—å…ƒä»¶
 * ===================================
 * åŠŸèƒ½ï¼š
 * 1. é¡¯ç¤ºæ¼¢å­—èˆ‡å°æ‡‰æ³¨éŸ³
 * 2. æ ¹æ“šã€Œé­”æ³•çœ¼é¡ã€ç‹€æ…‹é¡¯ç¤º/éš±è—æ³¨éŸ³
 * 3. é»æ“Šå–®å­—å¯æš«æ™‚é¡¯ç¤ºæ³¨éŸ³ï¼ˆTap-to-Revealï¼‰
 * 
 * ğŸ¯ CRITICAL CSS LOGIC:
 * - éš±è—æ³¨éŸ³æ™‚ä½¿ç”¨ opacity-0 + select-none
 * - åš´ç¦ä½¿ç”¨ display: none
 * - å¿…é ˆä¿ç•™ <rt> çš„é«˜åº¦ä½”ä½
 * - ç¢ºä¿æ¼¢å­—ä½ç½®åœ¨åˆ‡æ›æ™‚å®Œå…¨ä¸å‹• (Zero Layout Shift)
 */

// ç°¡æ˜“æ³¨éŸ³å°ç…§è¡¨ï¼ˆå¯æ“´å±•ï¼‰
const BOPOMOFO_MAP = {
    'æˆ‘': 'ã„¨ã„›Ë‡', 'ä½ ': 'ã„‹ã„§Ë‡', 'ä»–': 'ã„Šã„š', 'å¥¹': 'ã„Šã„š', 'å®ƒ': 'ã„Šã„š',
    'æ˜¯': 'ã„•Ë‹', 'çš„': 'ã„‰ã„œË™', 'äº†': 'ã„Œã„œË™', 'åœ¨': 'ã„—ã„Ë‹', 'æœ‰': 'ã„§ã„¡Ë‡',
    'é€™': 'ã„“ã„œË‹', 'é‚£': 'ã„‹ã„šË‹', 'ä»€': 'ã„•ã„£ËŠ', 'éº¼': 'ã„‡ã„œË™', 'ä¸': 'ã„…ã„¨Ë‹',
    'å’Œ': 'ã„ã„œËŠ', 'èˆ‡': 'ã„©Ë‡', 'å°±': 'ã„ã„§ã„¡Ë‹', 'éƒ½': 'ã„‰ã„¡', 'æœƒ': 'ã„ã„¨ã„ŸË‹',
    'èƒ½': 'ã„‹ã„¥ËŠ', 'å¯': 'ã„ã„œË‡', 'ä»¥': 'ã„§Ë‡', 'è¦': 'ã„§ã„ Ë‹', 'æƒ³': 'ã„’ã„§ã„¤Ë‡',
    'çœ‹': 'ã„ã„¢Ë‹', 'èªª': 'ã„•ã„¨ã„›', 'è½': 'ã„Šã„§ã„¥', 'åš': 'ã„—ã„¨ã„›Ë‹', 'å»': 'ã„‘ã„©Ë‹',
    'ä¾†': 'ã„Œã„ËŠ', 'èµ°': 'ã„—ã„¡Ë‡', 'åƒ': 'ã„”', 'å–': 'ã„ã„œ', 'ç¡': 'ã„•ã„¨ã„ŸË‹',
    'ç©': 'ã„¨ã„¢ËŠ', 'è·‘': 'ã„†ã„ Ë‡', 'è·³': 'ã„Šã„§ã„ Ë‹', 'é£›': 'ã„ˆã„Ÿ', 'æ¸¸': 'ã„§ã„¡ËŠ',
    'å¤§': 'ã„‰ã„šË‹', 'å°': 'ã„’ã„§ã„ Ë‡', 'å¤š': 'ã„‰ã„¨ã„›', 'å°‘': 'ã„•ã„ Ë‡', 'å¥½': 'ã„ã„ Ë‡',
    'å£': 'ã„ã„¨ã„Ë‹', 'æ–°': 'ã„’ã„§ã„£', 'èˆŠ': 'ã„ã„§ã„¡Ë‹', 'é«˜': 'ã„ã„ ', 'ä½': 'ã„‰ã„§',
    'é•·': 'ã„”ã„¤ËŠ', 'çŸ­': 'ã„‰ã„¨ã„¢Ë‡', 'å¿«': 'ã„ã„¨ã„Ë‹', 'æ…¢': 'ã„‡ã„¢Ë‹', 'é ': 'ã„©ã„¢Ë‡',
    'è¿‘': 'ã„ã„§ã„£Ë‹', 'ä¸Š': 'ã„•ã„¤Ë‹', 'ä¸‹': 'ã„’ã„§ã„šË‹', 'å·¦': 'ã„—ã„¨ã„›Ë‡', 'å³': 'ã„§ã„¡Ë‹',
    'å‰': 'ã„‘ã„§ã„¢ËŠ', 'å¾Œ': 'ã„ã„¡Ë‹', 'è£¡': 'ã„Œã„§Ë‡', 'å¤–': 'ã„¨ã„Ë‹', 'ä¸­': 'ã„“ã„¨ã„¥',
    'å¤©': 'ã„Šã„§ã„¢', 'åœ°': 'ã„‰ã„§Ë‹', 'æ—¥': 'ã„–Ë‹', 'æœˆ': 'ã„©ã„Ë‹', 'æ˜Ÿ': 'ã„’ã„§ã„¥',
    'å±±': 'ã„•ã„¢', 'æ°´': 'ã„•ã„¨ã„ŸË‡', 'ç«': 'ã„ã„¨ã„›Ë‡', 'é¢¨': 'ã„ˆã„¥', 'é›²': 'ã„©ã„£ËŠ',
    'é›¨': 'ã„©Ë‡', 'é›ª': 'ã„’ã„©ã„Ë‡', 'èŠ±': 'ã„ã„¨ã„š', 'è‰': 'ã„˜ã„ Ë‡', 'æ¨¹': 'ã„•ã„¨Ë‹',
    'é­š': 'ã„©ËŠ', 'é³¥': 'ã„‹ã„§ã„ Ë‡', 'è²“': 'ã„‡ã„ ', 'ç‹—': 'ã„ã„¡Ë‡', 'å…”': 'ã„Šã„¨Ë‹',
    'ç‰›': 'ã„‹ã„§ã„¡ËŠ', 'é¦¬': 'ã„‡ã„šË‡', 'ç¾Š': 'ã„§ã„¤ËŠ', 'è±¬': 'ã„“ã„¨', 'é›': 'ã„ã„§',
    'çˆ¸': 'ã„…ã„šË‹', 'åª½': 'ã„‡ã„š', 'çˆº': 'ã„§ã„ËŠ', 'å¥¶': 'ã„‹ã„Ë‡', 'å“¥': 'ã„ã„œ',
    'å§': 'ã„ã„§ã„Ë‡', 'å¼Ÿ': 'ã„‰ã„§Ë‹', 'å¦¹': 'ã„‡ã„ŸË‹', 'æœ‹': 'ã„†ã„¥ËŠ', 'å‹': 'ã„§ã„¡Ë‡',
    'æ•…': 'ã„ã„¨Ë‹', 'äº‹': 'ã„•Ë‹', 'æ›¸': 'ã„•ã„¨', 'å­—': 'ã„—Ë‹', 'ç•«': 'ã„ã„¨ã„šË‹',
    'é–‹': 'ã„ã„', 'å§‹': 'ã„•Ë‡', 'çµ': 'ã„ã„§ã„ËŠ', 'æŸ': 'ã„•ã„¨Ë‹', 'å¾': 'ã„˜ã„¨ã„¥ËŠ',
    'å¾ˆ': 'ã„ã„£Ë‡', 'å¤ª': 'ã„Šã„Ë‹', 'çœŸ': 'ã„“ã„£', 'å‡': 'ã„ã„§ã„šË‡', 'å°': 'ã„‰ã„¨ã„ŸË‹',
    'éŒ¯': 'ã„˜ã„¨ã„›Ë‹', 'å•': 'ã„¨ã„£Ë‹', 'ç­”': 'ã„‰ã„šËŠ', 'çŸ¥': 'ã„“', 'é“': 'ã„‰ã„ Ë‹',
    'æ„›': 'ã„Ë‹', 'å–œ': 'ã„’ã„§Ë‡', 'æ­¡': 'ã„ã„¨ã„¢', 'æ€•': 'ã„†ã„šË‹', 'ç¬‘': 'ã„’ã„§ã„ Ë‹',
    'å“­': 'ã„ã„¨', 'å¿ƒ': 'ã„’ã„§ã„£', 'æ‰‹': 'ã„•ã„¡Ë‡', 'è…³': 'ã„ã„§ã„ Ë‡', 'é ­': 'ã„Šã„¡ËŠ',
    'çœ¼': 'ã„§ã„¢Ë‡', 'è€³': 'ã„¦Ë‡', 'å£': 'ã„ã„¡Ë‡', 'é¼»': 'ã„…ã„§ËŠ', 'è‡‰': 'ã„Œã„§ã„¢Ë‡',
    'ä¸€': 'ã„§', 'äºŒ': 'ã„¦Ë‹', 'ä¸‰': 'ã„™ã„¢', 'å››': 'ã„™Ë‹', 'äº”': 'ã„¨Ë‡',
    'å…­': 'ã„Œã„§ã„¡Ë‹', 'ä¸ƒ': 'ã„‘ã„§', 'å…«': 'ã„…ã„š', 'ä¹': 'ã„ã„§ã„¡Ë‡', 'å': 'ã„•ËŠ',
    'ç™¾': 'ã„…ã„Ë‡', 'åƒ': 'ã„‘ã„§ã„¢', 'è¬': 'ã„¨ã„¢Ë‹', 'å¹´': 'ã„‹ã„§ã„¢ËŠ', 'æ­²': 'ã„™ã„¨ã„ŸË‹',
    'ä»Š': 'ã„ã„§ã„£', 'æ˜': 'ã„‡ã„§ã„¥ËŠ', 'æ˜¨': 'ã„—ã„¨ã„›ËŠ', 'æ—©': 'ã„—ã„ Ë‡', 'æ™š': 'ã„¨ã„¢Ë‡',
    'åˆ': 'ã„¨Ë‡', 'æ™‚': 'ã„•ËŠ', 'åˆ†': 'ã„ˆã„£', 'ç§’': 'ã„‡ã„§ã„ Ë‡', 'é»': 'ã„‰ã„§ã„¢Ë‡',
    'å­¸': 'ã„’ã„©ã„ËŠ', 'æ ¡': 'ã„’ã„§ã„ Ë‹', 'è€': 'ã„Œã„ Ë‡', 'å¸«': 'ã„•', 'ç”Ÿ': 'ã„•ã„¥',
    'ç´…': 'ã„ã„¨ã„¥ËŠ', 'è—': 'ã„Œã„¢ËŠ', 'ç¶ ': 'ã„Œã„©Ë‹', 'é»ƒ': 'ã„ã„¨ã„¤ËŠ', 'ç™½': 'ã„…ã„ËŠ',
    'é»‘': 'ã„ã„Ÿ', 'ç²‰': 'ã„ˆã„£Ë‡', 'æ©™': 'ã„”ã„¥ËŠ', 'ç´«': 'ã„—Ë‡', 'è‰²': 'ã„™ã„œË‹',
    'å®¶': 'ã„ã„§ã„š', 'æˆ¿': 'ã„ˆã„¤ËŠ', 'é–€': 'ã„‡ã„£ËŠ', 'çª—': 'ã„”ã„¨ã„¤', 'åºŠ': 'ã„”ã„¨ã„¤ËŠ',
    'æ¡Œ': 'ã„“ã„¨ã„›', 'æ¤…': 'ã„§Ë‡', 'é£¯': 'ã„ˆã„¢Ë‹', 'èœ': 'ã„˜ã„Ë‹', 'è‚‰': 'ã„–ã„¡Ë‹',
    'è›‹': 'ã„‰ã„¢Ë‹', 'ç±³': 'ã„‡ã„§Ë‡', 'ç³–': 'ã„Šã„¤ËŠ', 'æœ': 'ã„ã„¨ã„›Ë‡', 'éºµ': 'ã„‡ã„§ã„¢Ë‹',
    'è»Š': 'ã„”ã„œ', 'èˆ¹': 'ã„”ã„¨ã„¢ËŠ', 'è·¯': 'ã„Œã„¨Ë‹', 'æ©‹': 'ã„‘ã„§ã„ ËŠ', 'ç«™': 'ã„“ã„¢Ë‹',
};

// å–å¾—æ³¨éŸ³
const getBopomofo = (char) => BOPOMOFO_MAP[char] || null;

// æª¢æŸ¥æ˜¯å¦ç‚ºæ¼¢å­—
const isChineseChar = (char) => /[\u4e00-\u9fff]/.test(char);

// å–®ä¸€å­—å…ƒå…ƒä»¶
const SingleRubyCharacter = ({
    char,
    showRuby,
    onTap,
    tappable = false,
}) => {
    const bopomofo = getBopomofo(char);
    const hasRuby = bopomofo && isChineseChar(char);

    if (!hasRuby) {
        // éæ¼¢å­—æˆ–ç„¡æ³¨éŸ³è³‡æ–™ï¼Œç›´æ¥è¿”å›
        return <span>{char}</span>;
    }

    return (
        <ruby
            onClick={tappable && !showRuby ? onTap : undefined}
            className={tappable && !showRuby ? 'cm-char-tappable' : ''}
        >
            {char}
            <rp>(</rp>
            <rt className={showRuby ? '' : 'cm-hidden'}>
                {bopomofo}
            </rt>
            <rp>)</rp>
        </ruby>
    );
};

// ä¸»è¦å…ƒä»¶
const RubyCharacter = ({
    text = '',
    className = '',
    enableTapToReveal = true, // æ˜¯å¦å•Ÿç”¨é»æ“Šé¡¯ç¤º
}) => {
    const { isGlassesOn } = useChildMode();
    const [revealedChars, setRevealedChars] = useState(new Set());

    // é»æ“Šé¡¯ç¤ºå–®å€‹å­—çš„æ³¨éŸ³
    const handleTap = (index) => {
        if (!enableTapToReveal) return;

        setRevealedChars(prev => {
            const newSet = new Set(prev);
            if (newSet.has(index)) {
                newSet.delete(index);
            } else {
                newSet.add(index);
            }
            return newSet;
        });
    };

    // ç•¶çœ¼é¡ç‹€æ…‹æ”¹è®Šæ™‚ï¼Œæ¸…é™¤æ‰‹å‹•é¡¯ç¤ºçš„å­—å…ƒ
    React.useEffect(() => {
        if (isGlassesOn) {
            setRevealedChars(new Set());
        }
    }, [isGlassesOn]);

    // æ¸²æŸ“æ–‡å­—
    const characters = Array.from(text);

    return (
        <span className={`cm-ruby-text ${className}`}>
            {characters.map((char, index) => (
                <SingleRubyCharacter
                    key={index}
                    char={char}
                    showRuby={isGlassesOn || revealedChars.has(index)}
                    onTap={() => handleTap(index)}
                    tappable={enableTapToReveal && !isGlassesOn}
                />
            ))}
        </span>
    );
};

export default RubyCharacter;
